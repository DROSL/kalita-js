!function(){"use strict";function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function t(e){return function(e){if(Array.isArray(e))return r(e)}(e)||function(e){if("undefined"!=typeof Symbol&&Symbol.iterator in Object(e))return Array.from(e)}(e)||n(e)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function n(e,t){if(e){if("string"==typeof e)return r(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);return"Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n?Array.from(e):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?r(e,t):void 0}}function r(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}function a(e,t){var r;if("undefined"==typeof Symbol||null==e[Symbol.iterator]){if(Array.isArray(e)||(r=n(e))||t&&e&&"number"==typeof e.length){r&&(e=r);var a=0,o=function(){};return{s:o,n:function(){return a>=e.length?{done:!0}:{done:!1,value:e[a++]}},e:function(e){throw e},f:o}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var i,s=!0,l=!1;return{s:function(){r=e[Symbol.iterator]()},n:function(){var e=r.next();return s=e.done,e},e:function(e){l=!0,i=e},f:function(){try{s||null==r.return||r.return()}finally{if(l)throw i}}}}var o=function(){function n(e){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,n),this.selection=e,this.range=e.getRangeAt(0),this.text=e.toString(),this.markNodes=[],this.wordNodes=[],this.markedWord=null,this.timer=null}var r,o,i;return r=n,(o=[{key:"_nodes",get:function(){var e=this.selection,t=this.range.commonAncestorContainer;return function t(n){var r,o=[];if(n.childNodes.length>0){var i,s=a(n.childNodes);try{for(s.s();!(i=s.n()).done;){var l=i.value;o=o.concat(t(l))}}catch(e){s.e(e)}finally{s.f()}}else n.nodeType===Node.TEXT_NODE&&n.length>0&&(r=n.parentElement,Boolean(r.offsetWidth||r.offsetHeight||r.getClientRects().length))&&e.containsNode(n)&&o.push(n);return o}(t)}},{key:"extend",value:function(){for(var e=this.range.startOffset;e>0&&" "!==this.range.startContainer.nodeValue.charAt(e-1);)e--;this.range.setStart(this.range.startContainer,e);for(var t=this.range.endOffset;t<this.range.endContainer.length&&" "!==this.range.endContainer.nodeValue.charAt(t);)t++;this.range.setEnd(this.range.endContainer,t),this.text=this.range.toString()}},{key:"prepare",value:function(){var e,t=a(this._nodes);try{for(t.s();!(e=t.n()).done;){var n=e.value,r=document.createRange();n===this.range.startContainer?r.setStart(n,this.range.startOffset):r.setStart(n,0),n===this.range.endContainer?r.setEnd(n,this.range.endOffset):r.setEnd(n,n.length);var o=document.createElement("span");r.surroundContents(o),this.markNodes.push(o);for(var i=o.lastChild,s=0,l=0;l<=i.nodeValue.length;){if(" "===i.nodeValue.charAt(l)||l===i.nodeValue.length){if(l>s){var d=document.createRange();d.setStart(i,s),d.setEnd(i,l);var c=document.createElement("span");d.surroundContents(c),this.wordNodes.push(c),i=o.lastChild,s=0,l=0}s=l+1}l++}}}catch(e){t.e(e)}finally{t.f()}this.selection.empty()}},{key:"highlight",value:function(){var e,t=a(this.markNodes);try{for(t.s();!(e=t.n()).done;)e.value.classList.add("kalita-marked")}catch(e){t.e(e)}finally{t.f()}}},{key:"lowlight",value:function(){var e,t=a(this.markNodes);try{for(t.s();!(e=t.n()).done;)e.value.classList.remove("kalita-marked")}catch(e){t.e(e)}finally{t.f()}}},{key:"play",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;clearInterval(this.timer);var n=new Date,r=new Date(n);r.setSeconds(r.getSeconds()-t);var a=new Date(r);a.setSeconds(a.getSeconds()+e);var o=this.wordNodes.reduce((function(e,t){return e+t.lastChild.length}),0),i=0,s=this.wordNodes.map((function(t){var n=new Date(r);return n.setSeconds(n.getSeconds()+i/o*e),i+=t.lastChild.length,{object:t,startAt:n}})).filter((function(e){return e.startAt>=n})),l=-1,d=function(){var e=new Date;e>a&&(this.markedWord.classList.remove("kalita-word"),this.markedWord,clearInterval(this.timer)),l+1<s.length&&e>=s[l+1].startAt&&(this.markedWord&&this.markedWord.classList.remove("kalita-word"),this.markedWord=s[++l].object,this.markedWord.classList.add("kalita-word"))};this.timer=setInterval(d,100)}},{key:"pause",value:function(){clearInterval(this.timer)}},{key:"destroy",value:function(){var e,n;for(clearInterval(this.timer);e=this.wordNodes.pop();){var r;(r=e).replaceWith.apply(r,t(e.childNodes))}for(;n=this.markNodes.pop();){var a;(a=n).replaceWith.apply(a,t(n.childNodes))}}}])&&e(r.prototype,o),i&&e(r,i),n}(),i=null;document.addEventListener("selectstart",(function(){i&&(s.pause(),s.src=null,i.destroy())})),document.addEventListener("mouseup",(function(){var e=window.getSelection();if(e&&e.toString()){(i=new o(e)).extend(),i.prepare(),i.highlight();var t=encodeURIComponent(i.text);s.src="".concat("http://192.168.178.23:8080/speak","?text=").concat(t)}}));var s=document.createElement("audio");s.controls=!0,s.autoplay=!0,s.addEventListener("play",(function(){i.highlight(),i.play(s.duration,s.currentTime)})),s.addEventListener("pause",(function(){i.pause()})),s.addEventListener("ended",(function(){i.lowlight()})),document.getElementById("kalita-player").appendChild(s)}();
